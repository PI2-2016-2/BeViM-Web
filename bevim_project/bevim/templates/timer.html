{% extends "base.html" %}
{% load bootstrap3 %}
{% load i18n %}
{% load bootstrap_ui_tags %}

{% block content %}

	<div class="jobs_info" id="jobs_info" style="display: none;">
    	{{ jobs_info }}
	</div>

	<div class="row" style="margin-top: 10%;">
		<div class="row">
		</div>

		<div class="col-md-4">
		</div>
		<div class="col-md-4">

			<div class="panel panel-primary">
	            <div class="panel-heading">
					<h2 class="panel-title"><b>Tempo do Ensaio</b></h2>
				    <br>
	                <div class="row">
	                    <div class="col-xs-3">
	                        <span style="font-size:5em;" class="glyphicon glyphicon-time"></span>
	                    </div>
	                    <div class="col-xs-9 text-right">
	                        <div class="huge"><h1 id="experimentTime"></h1></div>
	                    </div>
	                </div>
	            </div>
	        </div>
        </div>
		<div class="col-md-4">
		</div>
	</div>

	<div class="row">
		<div class="col-md-4">
			<div class="panel panel-primary">
		            <div class="panel-heading">
					    <h2 class="panel-title"><b>Hora Inicial</b></h2>
		            </div>
                        <div class="huge text-center">
    						<h1 id="initialTime"></h1>
                        </div>
		        </div>
		  	</div>
		<div class="col-md-4">

			    <div class="panel panel-primary">
	            <div class="panel-heading">
				    <h2 class="panel-title"><b>Hora Atual</b></h2>
	            </div>
	                <div class="huge text-center">
	                	<h1 id="elapsedTime"></h1>
	                </div>
	        </div>
	    </div>
		<div class="col-md-4">
			<div class="panel panel-primary">
	            <div class="panel-heading">
				    <h2 class="panel-title"><b>Hora Final</b></h2>
	            </div>
                    <div class="huge text-center">
						<h1 id="finalTime"><i class='fa fa-spinner fa-spin fa-fw' aria-hidden='true'></i></h1>
                    </div>
	        </div>
		</div>
		{% csrf_token %}
		<div id="urlaccess" style="display: none;">
        	{% url 'free_equipment' experiment_id%}
	    </div>
	</div>

	<div id="jobresult">RESULTADO: <br></div>

	<script type="text/javascript">
		var dateObject = new Date();
    	var hours = dateObject.getHours();
    	var minutes = dateObject.getMinutes();
    	var seconds = dateObject.getSeconds();

    	var startTime = dateObject.getTime();

    	var initialTime = document.getElementById("initialTime");
    	initialTime.innerHTML = hours + ":" + minutes + ":" + seconds;

    	var jobsInfo = JSON.parse(document.querySelector(".jobs_info").textContent);

    	console.log(jobsInfo);

    	var time = jobsInfo.total_time;
    	var experimentTime = document.getElementById("experimentTime");
 		experimentTime.innerHTML = time + " segundos";

		function updateElapsedTime() {
			var elapsedTime = document.getElementById("elapsedTime");

			var dateElapsed = new Date();

			checkJobTimes(dateElapsed);

			elapsedTime.innerHTML =  dateElapsed.getHours() + ":" + dateElapsed.getMinutes()+ ":" + dateElapsed.getSeconds();
		}

		function checkJobTimes(nowTime){

			var jobs = jobsInfo.jobs;
			for(var job in jobs){

				// The first job is fired when the test begins
				if(job != 1){

					// The job N must start when the job N-1 finish
					var jobTime = calculateJobNTime(jobs, job-1);

					// Add the job N-1 time to the start time
					var initTime = new Date(startTime);
					var jobCurrentTime = initTime;
					jobCurrentTime.setSeconds(jobCurrentTime.getSeconds() + jobTime);

					if(nowTime.toTimeString() === jobCurrentTime.toTimeString()){
						console.log("JOB " + job +" FIRED IN:");
						console.log(nowTime.toTimeString());
						console.log("/////");
						fireJob(job);
					}
				}
			}
		}

		/**
		 * Calculates the time needed to N job in a list of jobs
		 */
		function calculateJobNTime(jobs, job){

			// If is the first job
			if(job == 1){
				return jobs[1].time;
			}else{
				return (calculateJobNTime(jobs, job-1) + jobs[job].time);
			}
		}

		function fireJob(job){

			var previous = $("#jobresult").html() + "<br>";
			$("#jobresult").html(previous + "Job " + job + " reached in " + (new Date().toTimeString()));

			//**** Make a request here to the rapsberry server to change the frequency ****//
		}

		fireJob(1); // Start the first job when the experiment begins
		var timer = setInterval(updateElapsedTime, 1000);

		function stopUpdate() {
			clearInterval(timer);

			var finalTime = document.getElementById("finalTime");
			var finalDate = new Date();
			finalTime.innerHTML = finalDate.getHours() + ":" + finalDate.getMinutes() + ":" + finalDate.getSeconds();

			freeEquipment();
		}

		function freeEquipment(){
		  	var url_post = $( "#urlaccess" ).html()
			$.ajax({
				type:"POST",
				url: url_post,
				data: {},
			    beforeSend: function(xhr, settings) {
					var token = $('input[name="csrfmiddlewaretoken"]').prop('value');
		        	xhr.setRequestHeader("X-CSRFToken", token);
		      	},
				success: function(){
				}
			});
		}
		var timeToStop = time*1000;

		setTimeout(stopUpdate, timeToStop);
	</script>
{% endblock %}
